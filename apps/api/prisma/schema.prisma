generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  NEW
  PRINTING
  PRINTED
}

enum FulfillmentType {
  PICKUP
  DELIVERY
  DINE_IN
}

enum PaymentMethod {
  PIX
  CASH
  CARD
}

enum PaidStatus {
  UNPAID
  PAID
}

enum OpenOverride {
  AUTO
  FORCE_OPEN
  FORCE_CLOSED
}

enum OptionGroupType {
  SINGLE
  MULTI
}

enum PricingRule {
  SUM
  MAX_OPTION
}

enum OrderType {
  PICKUP
  DELIVERY
  DINE_IN
}

enum PrintJobType {
  KITCHEN_ORDER
  CASHIER_TABLE_SUMMARY
}

enum PrintJobStatus {
  QUEUED
  PRINTED
  FAILED
}

enum TableStatus {
  FREE
  OPEN
  CLOSED
}

model Store {
  id              String                @id @default(uuid())
  name            String
  slug            String                @unique
  email           String?               @unique
  passwordHash    String?
  isActive        Boolean               @default(true)
  autoPrintEnabled Boolean              @default(false)
  cashierPrintEnabled Boolean           @default(false)
  allowPickup     Boolean               @default(true)
  allowDelivery   Boolean               @default(true)
  salonEnabled    Boolean               @default(false)
  salonTableCount Int                   @default(0)
  waiterPinHash   String?
  waiterPwaEnabled Boolean              @default(true)
  timezone        String                @default("America/Sao_Paulo")
  categories      Category[]
  orders          Order[]
  tables          SalonTable[]
  agents          Agent[]
  deliveryAreas   DeliveryArea[]
  hours           StoreHours?
  paymentSettings StorePaymentSettings?
  printJobs       PrintJob[]
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
}

model Category {
  id        String    @id @default(uuid())
  name      String
  active    Boolean   @default(true)
  storeId   String
  store     Store     @relation(fields: [storeId], references: [id])
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Product {
  id         String      @id @default(uuid())
  name       String
  price      Decimal     @db.Decimal(10, 2)
  active     Boolean     @default(true)
  isPromo    Boolean     @default(false)
  pricingRule PricingRule @default(SUM)
  availableDays Int[] @default([])
  categoryId String
  category   Category    @relation(fields: [categoryId], references: [id])
  orderItems OrderItem[]
  optionGroups ProductOptionGroup[]
  availabilityWindows ProductAvailabilityWindow[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

model ProductAvailabilityWindow {
  id          String   @id @default(uuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  startMinute Int
  endMinute   Int
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
}

model Order {
  id                  String          @id @default(uuid())
  storeId             String
  store               Store           @relation(fields: [storeId], references: [id])
  status              OrderStatus     @default(NEW)
  fulfillmentType     FulfillmentType
  orderType           OrderType       @default(PICKUP)
  customerName        String?
  customerPhone       String?
  notes               String?
  addressLine         String?
  addressNumber       String?
  addressNeighborhood String?
  addressCity         String?
  addressReference    String?
  deliveryAreaId      String?
  deliveryArea        DeliveryArea?   @relation(fields: [deliveryAreaId], references: [id])
  tableId             String?
  tableSessionId      String?
  table               SalonTable?     @relation(fields: [tableId], references: [id], onDelete: SetNull)
  deliveryFeeCents    Int             @default(0)
  paymentMethod       PaymentMethod   @default(CASH)
  changeForCents      Int?
  paidStatus          PaidStatus      @default(UNPAID)
  total               Decimal         @db.Decimal(10, 2)
  items               OrderItem[]
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@index([tableId, tableSessionId])
}

model OrderItem {
  id             String   @id @default(uuid())
  orderId        String
  order          Order    @relation(fields: [orderId], references: [id])
  productId      String
  product        Product  @relation(fields: [productId], references: [id])
  quantity       Int
  unitPriceCents Int
  notes          String?
  options        OrderItemOption[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model ProductOptionGroup {
  id         String            @id @default(uuid())
  productId  String
  product    Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  name       String
  type       OptionGroupType
  required   Boolean           @default(false)
  minSelect  Int               @default(0)
  maxSelect  Int               @default(0)
  sortOrder  Int               @default(0)
  items      ProductOptionItem[]
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  @@index([productId])
}

model ProductOptionItem {
  id               String              @id @default(uuid())
  groupId          String
  group            ProductOptionGroup  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  name             String
  priceDeltaCents  Int                 @default(0)
  isActive         Boolean             @default(true)
  sortOrder        Int                 @default(0)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([groupId])
}

model OrderItemOption {
  id             String   @id @default(uuid())
  orderItemId    String
  orderItem      OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  groupName      String
  itemName       String
  priceDeltaCents Int      @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([orderItemId])
}

model Agent {
  id        String   @id @default(uuid())
  storeId   String
  name      String
  token     String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store     Store    @relation(fields: [storeId], references: [id])
}

model Admin {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model DeliveryArea {
  id        String   @id @default(uuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  name      String
  feeCents  Int
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]

  @@index([storeId])
}

model StoreHours {
  id                String       @id @default(uuid())
  storeId           String       @unique
  store             Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  timezone          String       @default("America/Sao_Paulo")
  monOpen           String?
  monClose          String?
  monEnabled        Boolean      @default(false)
  tueOpen           String?
  tueClose          String?
  tueEnabled        Boolean      @default(false)
  wedOpen           String?
  wedClose          String?
  wedEnabled        Boolean      @default(false)
  thuOpen           String?
  thuClose          String?
  thuEnabled        Boolean      @default(false)
  friOpen           String?
  friClose          String?
  friEnabled        Boolean      @default(false)
  satOpen           String?
  satClose          String?
  satEnabled        Boolean      @default(false)
  sunOpen           String?
  sunClose          String?
  sunEnabled        Boolean      @default(false)
  isOpenNowOverride OpenOverride @default(AUTO)
  closedMessage     String?
  updatedAt         DateTime     @updatedAt
}

model StorePaymentSettings {
  id         String   @id @default(uuid())
  storeId    String   @unique
  store      Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  acceptPix  Boolean  @default(true)
  acceptCash Boolean  @default(true)
  acceptCard Boolean  @default(true)
  pixKey     String?
  pixName    String?
  pixBank    String?
  updatedAt  DateTime @updatedAt
}

model SalonTable {
  id        String      @id @default(uuid())
  storeId   String
  store     Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  number    Int
  status    TableStatus @default(FREE)
  openedAt  DateTime?
  closedAt  DateTime?
  currentSessionId String?
  orders    Order[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([storeId, number])
  @@index([storeId])
}

model PrintJob {
  id             String         @id @default(uuid())
  storeId        String
  store          Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  type           PrintJobType
  status         PrintJobStatus
  tableId        String?
  tableSessionId String?
  payload        Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([storeId])
  @@index([tableId, tableSessionId])
}
